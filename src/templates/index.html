<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" href="/static/css/styles.css">
        <title>Backyard Bridge</title>
    </head>

    <body>
        <header>

        </header>

        <div class="content">
            <h1>Backyard Bridge</h1>
            <p>Your name: <span id="ws-id"></span></p>

            <form id="nameForm" onsubmit="updateUsername(event)">
                <input type="text" id="nameInput" placeholder="Enter your name" maxlength="20" />
                <button type="submit">OK</button>
            </form>

            <button id="createLobbyButton" onclick="createLobby()">Create Lobby</button>
            <input id="lobbyInput" placeholder="Enter lobby ID" style="display: inline;" />
            <button id="joinLobbyButton" onclick="joinLobby()" disabled>Join Lobby</button>
            <div id="errorMessage" style="color: red;"></div>

            <div id="lobbyControls" style="display: none;">
                <h2 id="lobbyMessage"></h2>
                <button id="startButton" onclick="startGame()" style="display: none;" disabled>Start Game</button>
                <button id="leaveButton" onclick="leaveLobby()" style="display: none;">Leave Lobby</button>
                <ul id="users"></ul>
            </div>

            <div id="currentCards" style="display: none;">
                <div class="current-card" id="leftCard">
                    <img src="/static/cards/closed_card.png" alt="closed_card.png" />
                    <div id="cards-left">
                        <p>Cards left:</p>
                        <p class="deck-len" id="cardsLeft"></p>
                    </div>
                </div>
                <div class="current-card" id="rightCard">
                    <div id="chosen-suite">
                    </div>
                </div>
            </div>

            <script>
                let ws;
                let lobbyId;
                let userId = Date.now().toString();
                let userName = userId;
                let isHost = false;

                const elements = {
                    wsId: document.querySelector("#ws-id"),
                    nameForm: document.getElementById("nameForm"),
                    createLobbyButton: document.getElementById("createLobbyButton"),
                    joinLobbyInput: document.getElementById("lobbyInput"),
                    joinLobbyButton: document.getElementById("joinLobbyButton"),
                    startButton: document.getElementById("startButton"),
                    leaveLobbyButton: document.getElementById("leaveButton"),
                    errorMessage: document.getElementById("errorMessage"),
                    lobbyControls: document.getElementById("lobbyControls"),
                    lobbyMessage: document.getElementById("lobbyMessage"),
                    usersList: document.getElementById("users"),
                    currentCards: document.getElementById("currentCards"),
                };

                elements.wsId.textContent = userName;

                elements.joinLobbyInput.addEventListener('input', function () {
                    elements.joinLobbyButton.disabled = !elements.joinLobbyInput.value.trim();
                });

                function updateUsername(event) {
                    event.preventDefault();
                    const newName = document.getElementById("nameInput").value.trim();
                    if (newName) {
                        userName = newName;
                        elements.wsId.textContent = userName;
                        elements.nameForm.style.display = "none";
                    }
                }

                function setLobbyUI(isHostView) {
                    elements.createLobbyButton.style.display = 'none';
                    elements.nameForm.style.display = "none";
                    elements.joinLobbyInput.style.display = 'none';
                    elements.joinLobbyButton.style.display = 'none';
                    elements.lobbyControls.style.display = "block";
                    elements.leaveLobbyButton.style.display = "inline";
                    elements.startButton.style.display = isHostView ? "block" : "none";
                    isHost = isHostView;
                }

                function createLobby() {
                    setLobbyUI(true);
                    initializeWebSocket('create_lobby', {user_name: userName});
                }

                async function joinLobby() {
                    const inputLobbyId = elements.joinLobbyInput.value.trim();
                    if (!inputLobbyId) return;

                    const response = await fetch(`/check_lobby/${inputLobbyId}`);
                    const data = await response.json();

                    if (data.exists) {
                        setLobbyUI(false);
                        initializeWebSocket('join_lobby', {user_name: userName, lobby_id: inputLobbyId});
                    } else {
                        showError("The lobby doesn't exist or no slots");
                    }
                }

                function initializeWebSocket(type, message) {
                    if (ws) {
                        ws.close(1000);
                    }
                    ws = new WebSocket(`ws://localhost:8000/ws/lobby/${userId}`);
                    ws.onopen = () => ws.send(JSON.stringify({type, ...message}));
                    ws.onmessage = handleWebSocketMessage;
                }

                function handleWebSocketMessage(event) {
                    const data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'lobby_created':
                            lobbyId = data.lobby_id;
                            elements.lobbyMessage.textContent = `You created lobby with ID: ${lobbyId}`;
                            break;
                        case 'joined_lobby':
                            lobbyId = data.lobby_id;
                            elements.lobbyMessage.textContent = `You entered lobby with ID: ${lobbyId}`;
                            updateUsers(data.users, false);
                            break;
                        case 'users_update':
                            updateUsers(data.users, data.is_host);
                            break;
                        case 'start_game':
                            startGame();
                            break;
                        case 'lobby_closed':
                            returnToMainPage();
                            break;
                        case 'toggle_start_button':
                            toggleStartButton(data.enable);
                            break;
                        case 'player_hand':
                            updatePlayerHand(data.hand, data.current_player, data.playable_cards);
                            updateCurrentCards(data.current_card, data.deck_len, data.chosen_suite);
                            whoseTurn(data.current_player);
                            break;
                    }
                }

                function showError(message) {
                    elements.errorMessage.textContent = message;
                    elements.errorMessage.style.display = "block";
                    setTimeout(() => elements.errorMessage.style.display = "none", 2000);
                }

                function startGame() {
                    if (isHost) {
                        ws.send(JSON.stringify({type: 'start_game'}));
                    }

                    ws = new WebSocket(`ws://localhost:8000/ws/game/${lobbyId}/${userId}`);

                    ws.onmessage = function (event) {
                        const data = JSON.parse(event.data);

                        if (data.type === 'player_hand') {
                            handleWebSocketMessage(event);
                        }
                    };

                    elements.lobbyControls.style.display = "none";
                    elements.currentCards.style.display = "flex";
                }

                function leaveLobby() {
                    ws.send(JSON.stringify({type: 'close_lobby', lobby_id: lobbyId}));

                    returnToMainPage();
                }

                function returnToMainPage() {
                    elements.lobbyControls.style.display = "none";
                    elements.createLobbyButton.style.display = 'inline';
                    elements.nameForm.style.display = "none";
                    elements.joinLobbyInput.style.display = 'inline';
                    elements.joinLobbyInput.value = '';
                    elements.joinLobbyButton.style.display = 'inline';
                    elements.joinLobbyButton.disabled = true;
                    elements.leaveLobbyButton.style.display = "none";
                    elements.errorMessage.style.display = "none";
                    elements.currentCards.style.display = "none";
                }

                function updateUsers(users, isHost) {
                    elements.usersList.innerHTML = '';
                    users.forEach(user => {
                        const userElement = document.createElement("li");
                        userElement.textContent = user.user_name;
                        elements.usersList.appendChild(userElement);
                    });
                    if (isHost) toggleStartButton(true);
                }

                function toggleStartButton(enable) {
                    elements.startButton.disabled = !enable;
                }

                function updatePlayerHand(hand, currentPlayer, playableCards) {
                    const playerHandDiv = document.getElementById("playerHand");
                    playerHandDiv.innerHTML = '';

                    const containerWidth = playerHandDiv.offsetWidth;
                    const cardWidth = 120;
                    const gap = 5;

                    const totalCardsWidth = hand.length * (cardWidth + gap) - gap;
                    let startLeftPosition = 0

                    let overlap = 0;
                    if (totalCardsWidth > containerWidth) {
                        overlap = (totalCardsWidth - containerWidth) / (hand.length - 1);
                        overlap = Math.min(overlap, cardWidth - gap);
                    } else {
                        startLeftPosition += (containerWidth - totalCardsWidth + gap) / 2;
                    }

                    hand.forEach((card, index) => {
                        const cardDiv = document.createElement('div');
                        cardDiv.classList.add('card');
                        cardDiv.style.left = `${startLeftPosition + index * (cardWidth - overlap) + gap * index}px`;

                        const isPlayable = playableCards.some(playableCard =>
                            playableCard.rank === card.rank && playableCard.suit === card.suit
                        );

                        if (currentPlayer.player_id === userId && isPlayable) {
                            cardDiv.style.bottom = '70px';

                            cardDiv.onclick = () => playCard(card);
                        }

                        const cardImage = document.createElement('img');
                        const cardName = `${card.rank}_${card.suit}`;
                        cardImage.src = `/static/cards/${cardName}.png`;
                        cardImage.alt = cardName;

                        cardDiv.appendChild(cardImage);
                        playerHandDiv.appendChild(cardDiv);
                    });
                }

                function whoseTurn(currentPlayer) {
                    const playerContainer = document.getElementById('playerContainer');
                    const whoseTurn = document.createElement('p');
                    whoseTurn.className = 'turnText';

                    if (currentPlayer.player_id === userId) {
                        whoseTurn.textContent = `It's your turn!`;
                    } else {
                        whoseTurn.textContent = `It's ${currentPlayer.user_name}'s turn!`;
                    }
                    playerContainer.appendChild(whoseTurn);
                }

                function updateCurrentCards(currentCard, deckLen, chosenSuite) {
                    const cardsLeftParagraph = document.getElementById('cardsLeft');
                    cardsLeftParagraph.textContent = `${deckLen}`;

                    const rightCardDiv = document.getElementById("rightCard");

                    const oldImage = rightCardDiv.querySelector('img');
                    if (oldImage) {
                        oldImage.remove();
                    }

                    const rightCardImage = document.createElement('img');
                    rightCardImage.src = `/static/cards/${currentCard.rank}_${currentCard.suit}.png`;
                    rightCardImage.alt = `${currentCard.rank}_${currentCard.suit}`;

                    rightCardDiv.appendChild(rightCardImage);

                    if (chosenSuite) {
                        const chosenSuiteFirstParagraph = document.createElement('p');
                        chosenSuiteFirstParagraph.textContent = `Chosen suit:`;
                        chosenSuiteFirstParagraph.style.margin = '16px 0 0 0';
                        const chosenSuiteSecondParagraph = document.createElement('p');
                        chosenSuiteSecondParagraph.className = 'suite-symbol';
                        chosenSuiteSecondParagraph.style.textAlign = 'center';
                        chosenSuiteSecondParagraph.style.color = `${chosenSuite.color}`
                        chosenSuiteSecondParagraph.textContent = `${chosenSuite.suit}`;

                        rightCardDiv.appendChild(chosenSuiteFirstParagraph);
                        rightCardDiv.appendChild(chosenSuiteSecondParagraph);
                    }
                }

                function playCard(card) {
                    const playerHandDiv = document.getElementById('playerHand');
                    const rightCardDiv = document.getElementById('rightCard');

                    const cardDiv = [...playerHandDiv.children].find(cardElement => {
                        const img = cardElement.querySelector('img');
                        return img.alt === `${card.rank}_${card.suit}`;
                    });

                    const startRect = cardDiv.getBoundingClientRect();
                    const endRect = rightCardDiv.getBoundingClientRect();

                    const cardClone = cardDiv.cloneNode(true);
                    document.body.appendChild(cardClone);

                    cardClone.style.position = 'absolute';
                    cardClone.style.left = `${startRect.left}px`;
                    cardClone.style.top = `${startRect.top}px`;
                    cardClone.style.width = `${startRect.width}px`;
                    cardClone.style.height = `${startRect.height}px`;
                    cardClone.style.transition = 'all 0.5s ease';

                    setTimeout(() => {
                        cardClone.style.left = `${endRect.left}px`;
                        cardClone.style.top = `${endRect.top}px`;
                        cardClone.style.width = `${endRect.width}px`;
                        cardClone.style.height = `${endRect.height}px`;
                    }, 50);

                    cardClone.addEventListener('transitionend', () => {
                        cardClone.remove();

                        const oldImage = rightCardDiv.querySelector('img');
                        if (oldImage) oldImage.remove();

                        const newCardImage = document.createElement('img');
                        newCardImage.src = `/static/cards/${card.rank}_${card.suit}.png`;
                        newCardImage.alt = `${card.rank}_${card.suit}`;

                        rightCardDiv.appendChild(newCardImage);

                        ws.send(JSON.stringify({
                            type: 'play_card',
                            card: card
                        }));
                    });
                }
            </script>
        </div>

        <footer>
            <div id="playerContainer">
                <div id="playerHand"></div>
            </div>
        </footer>

    </body>

</html>
