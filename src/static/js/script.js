let ws,lobbyId,errorTimeout,userId=Date.now().toString().slice(-9),userName=userId,isHost=!1,currentPlayer="",eventHandlersAdded=!1,game_over=!1;const elements={wsId:document.querySelector("#ws-id"),pS:document.querySelector("#pS"),nameForm:document.getElementById("nameForm"),createLobbyButton:document.getElementById("createLobbyButton"),joinLobbyInput:document.getElementById("lobbyInput"),joinLobbyButton:document.getElementById("joinLobbyButton"),startButton:document.getElementById("startButton"),leaveLobbyButton:document.getElementById("leaveButton"),errorMessage:document.getElementById("errorMessage"),lobbyControls:document.getElementById("lobbyControls"),lobbyMessage:document.getElementById("lobbyMessage"),usersHeader:document.getElementById("usersHeader"),usersList:document.getElementById("usersList"),currentCards:document.getElementById("currentCards"),nameInput:document.getElementById("nameInput"),playerHand:document.getElementById("playerHand"),turnText:document.getElementById("turnText"),cardsLeft:document.getElementById("cardsLeft"),rightCard:document.getElementById("rightCard"),leftCard:document.getElementById("leftCard"),jackWidget:document.getElementById("jack-widget"),rulesWidget:document.getElementById("rules-widget"),scoresRate:document.getElementById("scoresRate"),nameAndScores:document.getElementById("nameAndScores"),playerScores:document.getElementById("scores"),gameOverWidget:document.getElementById("game-over-widget"),playerContainer:document.getElementById("playerContainer"),welcomeMessage:document.getElementById("welcomeMessage")};function getWsBaseUrl(e){const t=["localhost","127.0.0.1"].includes(window.location.hostname);return`${t?"ws":"wss"}://${t?"localhost:8000":window.location.host}${e}`}function getHttpBaseUrl(e=""){return["localhost","127.0.0.1"].includes(window.location.hostname)?`http://localhost:8000${e}`:`${window.location.origin}${e}`}function updateUsername(e){e.preventDefault();const t=elements.nameInput.value.trim();t&&(userName=t,elements.wsId.textContent=userName,elements.nameForm.style.display="none",elements.wsId.style.display="block")}function setLobbyUI(e){elements.wsId.style.display="block",elements.welcomeMessage.style.display="none",elements.createLobbyButton.style.display="none",elements.nameForm.style.display="none",elements.joinLobbyInput.style.display="none",elements.joinLobbyButton.style.display="none",elements.lobbyControls.style.display="block",elements.leaveLobbyButton.style.display="inline",elements.startButton.style.display=e?"block":"none",isHost=e}function createLobby(){startLoadingAnimation(.3,.8),setLobbyUI(!0),initializeWebSocket("crl",{user_name:userName})}function preloadCardImages(){fetch("/get_cards").then((e=>e.json())).then((e=>{e.forEach((e=>{(new Image).src=e}))}))}async function joinLobby(){const e=elements.joinLobbyInput.value.trim();if(!e)return;const t=await fetch(`/check_lobby/${e}`),n=await t.json();n.exists?(startLoadingAnimation(.4,.9),setLobbyUI(!1),initializeWebSocket("jl",{user_name:userName,lobby_id:e})):await showError(n.msg,2)}function setAndCopyLobbyId(e,t){lobbyId=e;const n='<br><span class="small-text">(click to copy ID to clipboard)</span>';function s(){navigator.clipboard.writeText(e),document.getElementById("copyInfo")||(elements.lobbyMessage.innerHTML=t+'<br><span class="small-text" style="color: #ffa500" id="copyInfo">ID copied!</span>'),setTimeout((()=>{const e=document.getElementById("copyInfo");e&&e.remove(),elements.lobbyMessage.innerHTML=t+n}),2e3)}elements.lobbyMessage.innerHTML=t+n,elements.lobbyMessage.removeEventListener("click",s),elements.lobbyMessage.addEventListener("click",s)}function initializeWebSocket(e,t){ws&&ws.close(1e3),ws=new WebSocket(getWsBaseUrl(`/ws/lobby/${userId}`)),ws.onopen=()=>ws.send(JSON.stringify({type:e,...t})),ws.onmessage=handleWebSocketMessage,preloadCardImages()}function handleWebSocketMessage(e){const t=JSON.parse(e.data);switch(t.type){case"lcr":setAndCopyLobbyId(t.lobby_id,t.msg);break;case"jdl":setAndCopyLobbyId(t.lobby_id,t.msg),updateUsers(t.users,!1);break;case"uu":updateUsers(t.users,t.is_host);break;case"sg":startGame();break;case"lcl":returnToMainPage();break;case"tsb":toggleStartButton(t.enable);break;case"gd":checkScoresRate(t.scores_rate),updatePlayerHand(t.hand,t.current_player,t.playable_cards,"current"),updateOpponentData(t.players_hands),updateCurrentCards(t.current_card,t.deck_len,t.chosen_suit,t.player_options);break;case"wt":whoseTurn(t.msg,t.current_player);break;case"ft":firstTurn(t.current_card);break;case"nep":backToHomePage(t.msg,3);break;case"se":showError(t.msg,2);break;case"iib":showError(t.msg,4),isItBridge(t.current_card);break;case"go":removeHighlighted("#leftCard img"),showError(t.error_msg,5).then((()=>{showGameOverWidget(t.widget_msg,t.players_scores,t.player_scores)}));break;case"godc":game_over=!0,drawCard();break;case"lg":leaveGame(t.player_id);break;case"apc":playCard(t.card,"opponent");break;case"adc":change_player(t.current_player),animateDrawCard("opponent");break;case"gr":reset_game(t.players_scores,t.player_scores)}}function showError(e,t){return clearTimeout(errorTimeout),elements.errorMessage.innerHTML=e,elements.errorMessage.style.display="block",new Promise((e=>{errorTimeout=setTimeout((()=>{elements.errorMessage.innerHTML="",elements.errorMessage.style.display="none",e()}),1e3*t)}))}function startGame(){isHost&&ws.send(JSON.stringify({type:"sg"})),ws=new WebSocket(getWsBaseUrl(`/ws/game/${lobbyId}/${userId}`)),startLoadingAnimation(1,1.5),ws.onopen=()=>ws.send(JSON.stringify({type:"gs"})),ws.onmessage=function(e){handleWebSocketMessage(e)},setGameUI()}function setGameUI(){elements.lobbyControls.style.display="none",elements.currentCards.style.display="flex",elements.playerContainer.style.display="flex",elements.nameAndScores.style.flexDirection="row",elements.pS.innerHTML="0",elements.scoresRate.innerHTML="x1",elements.playerScores.style.display="block",elements.usersHeader.style.fontSize="12px",elements.usersList.style.fontSize="12px",elements.usersList.style.flexDirection="row";document.getElementById(userId).style.display="none";document.querySelectorAll(".opponentScores").forEach((e=>{e.style.display="flex",e.style.justifyContent="center"}));document.querySelectorAll(".opponent_hand").forEach((e=>{e.style.display="flex"}))}function leaveGame(e){const t=document.getElementById(e);t&&t.remove()}function leaveLobby(){ws.send(JSON.stringify({type:"cll",lobby_id:lobbyId})),returnToMainPage()}function returnToMainPage(){elements.lobbyControls.style.display="none",elements.welcomeMessage.style.display="block",elements.createLobbyButton.style.display="inline",elements.nameForm.style.display="none",elements.joinLobbyInput.style.display="inline",elements.joinLobbyInput.value="",elements.joinLobbyButton.style.display="inline",elements.joinLobbyButton.disabled=!0,elements.leaveLobbyButton.style.display="none",elements.errorMessage.style.display="none",elements.currentCards.style.display="none",elements.usersHeader.style.display="none",elements.usersList.style.display="none"}function updateUsers(e,t){elements.usersList.style.display="flex",elements.usersList.innerHTML="",elements.usersHeader.style.display="block",e.forEach((e=>{const t=document.createElement("div");t.className=e.user_id,t.id=e.user_id;const n=document.createElement("p");n.textContent=e.user_name,t.appendChild(n),elements.usersList.appendChild(t);const s=document.createElement("div");s.className="opponent_hand",s.id=`${e.user_id}_hand`;const r=document.createElement("div");r.className="opponentScores",r.id="opponentScores";const l=document.createElement("p");l.innerHTML="Scores:",l.style.marginRight="3px";const o=document.createElement("span");o.id=`${e.user_id}_oS`,o.style.fontWeight="bold",o.textContent="0",r.appendChild(l),r.appendChild(o),t.appendChild(r),t.appendChild(s)})),t&&toggleStartButton(!0)}function updateOpponentData(e){e.forEach((e=>{const t=document.getElementById(`${e.player_id}_hand`);t.innerHTML="";const n=21*e.hand_len-1;let s=0,r=0;n>100?(s=(n-100)/(e.hand_len-1),s=Math.min(s,19)):r=(100-n)/2;for(let n=0;n<e.hand_len;n++){const e=document.createElement("div");e.classList.add("opponent_card"),e.style.left=`${r+n*(20-s)+1*n}px`;const l=document.createElement("img");l.src="/static/cards/opponent_card.png",l.alt="opponent_card",e.appendChild(l),t.appendChild(e)}}))}function toggleStartButton(e){elements.startButton.disabled=!e}function updatePlayerHand(e,t,n,s){elements.playerHand.innerHTML="";const r=elements.playerHand.offsetWidth,l=95*e.length-5;let o=15,a=0;l>r-30?(a=(l-(r-30))/(e.length-1),a=Math.min(a,85)):o+=(r-l-30+5)/2,e.forEach(((e,r)=>{const l=document.createElement("div");l.classList.add("card"),l.style.left=`${o+r*(90-a)+5*r}px`;const i=n.some((t=>t.rank===e.rank&&t.suit===e.suit));t&&i&&(l.classList.add("highlighted-card-img"),l.style.bottom="50px",l.onclick=()=>playCard(e,s),l.style.cursor="pointer");const d=document.createElement("img"),c=`${e.rank}_${e.suit}`;d.src=`/static/cards/${c}.png`,d.alt=c,l.appendChild(d),elements.playerHand.appendChild(l)}))}function whoseTurn(e,t){elements.turnText.textContent=e,change_player(t),elements.turnText.classList.add("wave-effect"),setTimeout((()=>{elements.turnText.classList.remove("wave-effect")}),5e3)}function change_player(e){e&&(currentPlayer=e)}function updateCurrentCards(e,t,n,s){elements.cardsLeft.textContent=t;const r=elements.rightCard.querySelector("img");r&&r.remove();const l=document.createElement("img");n?(l.src=`/static/cards/${n.suit}.png`,l.alt=n.suit):(l.src=`/static/cards/${e.rank}_${e.suit}.png`,l.alt=`${e.rank}_${e.suit}`),elements.rightCard.appendChild(l),setTimeout((()=>{checkCurrentPlayerOptions(s)}),50)}async function playCard(e,t){if("current"===t){ws.send(JSON.stringify({type:"smm",card:e}));const t=[...elements.playerHand.children].find((t=>t.querySelector("img").alt===`${e.rank}_${e.suit}`));await animatePlayedCard(t)}else{const e=document.getElementById(currentPlayer).querySelector(".opponent_card img");await animatePlayedCard(e)}updateRightCard(e),"current"===t&&("J"===e.rank?showJackWidget(e):ws.send(JSON.stringify({type:"pc",card:e,chosen_suit:null})))}function updateRightCard(e){const t=elements.rightCard.querySelector("img");t&&t.remove();const n=document.createElement("img");n.src=`/static/cards/${e.rank}_${e.suit}.png`,n.alt=`${e.rank}_${e.suit}`,elements.rightCard.appendChild(n)}async function animatePlayedCard(e){const t=e.getBoundingClientRect(),n=elements.rightCard.getBoundingClientRect(),s=e.cloneNode(!0);document.body.appendChild(s),s.style.position="absolute",s.style.left=`${t.left}px`,s.style.top=`${t.top}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.transition="all 0.35s ease",setTimeout((()=>{e.style.display="none",s.style.left=`${n.left}px`,s.style.top=`${n.top}px`,s.style.width="90px",s.style.height="135px"}),30),await new Promise((e=>{setTimeout((()=>{document.body.contains(s)&&s.remove(),e()}),370)}))}async function drawCard(){ws.send(JSON.stringify({type:"smm"})),await animateDrawCard("current"),game_over?(ws.send(JSON.stringify({type:"go"})),game_over=!1):ws.send(JSON.stringify({type:"dc"}))}async function animateDrawCard(e){const t=elements.leftCard.getBoundingClientRect(),n=elements.leftCard.querySelector("img").cloneNode(!0);document.body.appendChild(n),n.style.position="absolute",n.style.left=`${t.left}px`,n.style.top=`${t.top}px`,n.style.width=`${t.width}px`,n.style.height=`${t.height}px`,n.style.transition="all 0.35s ease",setTimeout((()=>{let s,r,l;if("current"===e)s=elements.playerHand.getBoundingClientRect(),r=s.left+s.width/2-t.width/2,l=s.bottom-t.height-10,n.style.width=`${t.width}px`,n.style.height=`${t.height}px`;else{s=document.getElementById(`${currentPlayer}_hand`).querySelector(".opponent_card").getBoundingClientRect(),r=s.left,l=s.top,n.style.width="20px",n.style.height="30px"}n.style.left=`${r}px`,n.style.top=`${l}px`}),30),await new Promise((e=>{setTimeout((()=>{document.body.contains(n)&&n.remove(),e()}),370)}))}function skip_turn(){currentPlayer===userId&&(ws.send(JSON.stringify({type:"st"})),elements.errorMessage.style.display="none")}function colorSkipTurn(){const e=document.querySelector("#rightCard img");currentPlayer===userId&&e.classList.add("highlighted-card-img")}function colorDrawCard(){const e=document.querySelector("#leftCard img");currentPlayer===userId&&e.classList.add("highlighted-card-img")}function firstTurn(e){currentPlayer===userId&&("J"===e.rank?showJackWidget(e):ws.send(JSON.stringify({type:"pc",card:e,chosen_suit:null})))}function showJackWidget(e){elements.jackWidget.style.display="block";elements.playerHand.querySelectorAll(".card").forEach((e=>{e.onclick=null,e.style.cursor="default",e.style.bottom="10px",e.classList.remove("highlighted-card-img")}));const t=["♠","♥","♦","♣"];document.querySelectorAll(".jack-widget-grid div").forEach(((n,s)=>{let r=n.cloneNode(!0);n.replaceWith(r),r.addEventListener("click",(function(){const n=t[s];elements.jackWidget.style.display="none",ws.send(JSON.stringify({type:"pc",card:e,chosen_suit:n}))}))}))}function checkCurrentPlayerOptions(e){setDefaultDrawCard(),setDefaultSkipTurn(),currentPlayer===userId&&(e.must_draw?(colorDrawCard(),elements.leftCard.style.cursor="pointer",elements.leftCard.onclick=drawCard):e.must_skip?(colorSkipTurn(),elements.rightCard.style.cursor="pointer",elements.rightCard.onclick=skip_turn):(e.can_draw&&(colorDrawCard(),elements.leftCard.style.cursor="pointer",elements.leftCard.onclick=drawCard),e.can_skip&&(colorSkipTurn(),elements.rightCard.style.cursor="pointer",elements.rightCard.onclick=skip_turn)))}function setDefaultDrawCard(){currentPlayer===userId&&removeHighlighted("#leftCard img"),elements.leftCard.style.cursor="default",elements.leftCard.onclick=null}function setDefaultSkipTurn(){currentPlayer===userId&&removeHighlighted("#rightCard img"),elements.rightCard.style.cursor="default",elements.rightCard.onclick=null}function removeHighlighted(e){document.querySelector(e).classList.remove("highlighted-card-img")}async function showRulesWidget(){const e=await fetch("/rules"),t=await e.json();document.querySelector(".rules-column p").innerHTML=t.rules,elements.rulesWidget.style.display="flex",eventHandlersAdded||(document.getElementById("closeRulesWidget").addEventListener("click",closeRulesWidget),document.getElementById("rules-widget").addEventListener("click",(function(e){e.target===elements.rulesWidget&&closeRulesWidget()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&closeRulesWidget()})),eventHandlersAdded=!0)}function closeRulesWidget(){elements.rulesWidget.style.display="none",document.querySelector(".rules-column p").textContent=""}async function backToHomePage(e,t){await showError(e,t),window.location.href=getHttpBaseUrl()}function checkScoresRate(e){e!==elements.scoresRate.innerHTML&&(elements.scoresRate.innerHTML=e,elements.scoresRate.classList.add("wave-effect"),setTimeout((()=>{elements.scoresRate.classList.remove("wave-effect")}),5e3))}function startNewGame(){ws.send(JSON.stringify({type:"rg"}))}function reset_game(e,t){closeGameOverWidget(),elements.pS.textContent=t,elements.scoresRate.innerHTML="x1",e.forEach((e=>{document.getElementById(`${e.player_id}_oS`).textContent=e.scores}))}function isItBridge(e){setTimeout((()=>{elements.leftCard.querySelector("img").src="/static/cards/bridge.png",elements.leftCard.querySelector("img").alt="bridge",elements.leftCard.style.cursor="pointer",colorDrawCard(),elements.leftCard.onclick=()=>{ws.send(JSON.stringify({type:"go"})),resetCardState(e)},elements.rightCard.querySelector("img").src="/static/cards/continue.png",elements.rightCard.querySelector("img").alt="continue",elements.rightCard.onclick=()=>{skip_turn(),resetCardState(e)}}),50)}function resetCardState(e){elements.leftCard.querySelector("img").src="/static/cards/closed_card.png",elements.leftCard.querySelector("img").alt="closed_card",setDefaultDrawCard(),elements.rightCard.querySelector("img").src=`/static/cards/${e.rank}_${e.suit}.png`,elements.rightCard.querySelector("img").alt=`${e.rank}_${e.suit}`,setDefaultSkipTurn()}function showGameOverWidget(e,t,n){t.forEach((e=>{document.getElementById(`${e.player_id}_oS`).textContent=e.scores})),elements.pS.textContent=n,document.querySelector(".results-column p").innerHTML=e,elements.gameOverWidget.style.display="flex"}function closeGameOverWidget(){elements.gameOverWidget.style.display="none",document.querySelector(".results-column p").textContent=""}function startLoadingAnimation(e,t){const n=document.getElementById("overlay"),s=document.querySelector(".progress");n.style.display="flex",s.style.width="0%",s.style.transition=`width ${e}s linear`,setTimeout((()=>{s.style.width="100%"}),50),setTimeout((()=>{n.style.display="none"}),1e3*t)}elements.wsId.textContent=userName,elements.nameInput.placeholder=userName,elements.joinLobbyInput.addEventListener("input",(function(){elements.joinLobbyButton.disabled=!elements.joinLobbyInput.value.trim()})),elements.nameInput.addEventListener("input",(function(){const e=elements.nameInput.value.trim();document.getElementById("changeName").disabled=0===e.length}));